<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Amazon Deforestation – Rondônia</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body { margin:0; }
  #map { height:100vh; }
  .info {
    background:white;
    padding:8px;
    border-radius:5px;
    box-shadow:0 0 10px rgba(0,0,0,.3);
    z-index: 1000; /* FIX 1: ensure Switch Year button is visible */
  }
  .legend i {
    display:inline-block;
    width:12px;
    height:12px;
    margin-right:4px;
  }
</style>
</head>
<body>

<div id="map"></div>

<script>
// ================== MAP ==================
const map = L.map('map').setView([-10.5, -62.5], 8);

// Base layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18
}).addTo(map);

// ================== IMAGE OVERLAYS ==================
const imageBounds = [[-13, -65], [-8, -60]];

const overlay2023 = L.imageOverlay('2023_falsecolor.png', imageBounds, {opacity:0.85});
const overlay2024 = L.imageOverlay('2024_falsecolor.png', imageBounds, {opacity:0.85});

overlay2023.addTo(map); // start with 2023
let currentYear = '2023';

// ================== HOTSPOTS LAYER ==================
const hotspots = L.geoJSON(null, {
  style: {
    color: '#ffff00',
    weight: 1.2,
    fillColor: '#ffff00',
    fillOpacity: 0.45
  },
  onEachFeature: function(feature, layer) {
    const areaRaw = feature.properties.area_ha;
    const areaHa = (!isNaN(areaRaw)) ? Number(areaRaw) : null;
    layer.bindPopup(
      `<b>Deforestation Hotspot</b><br>
       Area: ${areaHa ? areaHa.toFixed(2) + ' ha' : 'N/A'}<br>
       Detected 2023–2024`
    );
  }
});

// ================== LOAD GEOJSON ==================
fetch('https://raw.githubusercontent.com/frankraDIUM/Amazon-Deforestation-Monitoring-Sub-Region-Analysis-Rondonia-Hotspot-/main/Loss_Hotspots_Leaflet.geojson')
  .then(res => res.json())
  .then(data => {
    if (!data || !data.features || data.features.length === 0) {
      console.error('GeoJSON loaded but contains no features (possible Git LFS issue)');
      return;
    }
    console.log('Hotspots loaded:', data.features.length);
    hotspots.addData(data); // FIX 2: load data safely, do NOT auto-add to map
  })
  .catch(err => console.error('GeoJSON load failed:', err));

// ================== LAYER CONTROL ==================
const overlays = {
  "Deforestation Hotspots": hotspots
};

const baseLayers = {
  "2023 False Color": overlay2023,
  "2024 False Color": overlay2024
};

L.control.layers(baseLayers, overlays, {
  position: 'topright',
  collapsed: false
}).addTo(map);

// ================== SWITCH YEAR BUTTON ==================
const toggleControl = L.control({ position: 'topleft' });
toggleControl.onAdd = function () {
  const div = L.DomUtil.create('div', 'info');
  div.innerHTML = '<button onclick="toggleYear()">Switch Year</button>';
  return div;
};
toggleControl.addTo(map);

window.toggleYear = function () {
  if (currentYear === '2023') {
    map.removeLayer(overlay2023);
    map.addLayer(overlay2024);
    currentYear = '2024';
  } else {
    map.removeLayer(overlay2024);
    map.addLayer(overlay2023);
    currentYear = '2023';
  }
  console.log('Year toggled:', currentYear);
};

// ================== INFO PANEL ==================
const infoPanel = L.control({ position: 'bottomleft' });
infoPanel.onAdd = function () {
  const div = L.DomUtil.create('div', 'info');
  div.innerHTML = `
    <h4>Amazon Deforestation Monitoring</h4>
    <p>
      Rondônia sub-region<br>
      Sentinel-2 false color (2023 vs 2024)<br>
      Hotspots: NDVI drop ≥ 0.20<br>
      Estimated loss: ~579 km²
    </p>
  `;
  return div;
};
infoPanel.addTo(map);

// ================== LEGEND ==================
const legend = L.control({position: 'bottomright'});
legend.onAdd = function () {
  const div = L.DomUtil.create('div', 'info legend');
  div.innerHTML = `
    <h4>Legend</h4>
    <div>
      <i style="background:#ffff00"></i> Potential Deforestation Hotspots (2023–2024)<br>
      <i style="background:#ff3333"></i> High NDVI drop + low 2024 NDVI
    </div>
    <div style="margin-top:8px;">
      <strong>Base Layers:</strong><br>
      <span style="color:#006400">2023 False Color (NIR-Red-Green)</span><br>
      <span style="color:#006400">2024 False Color (NIR-Red-Green)</span>
    </div>
  `;
  return div;
};
legend.addTo(map);
</script>
</body>
</html>
