<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Amazon Deforestation – Rondônia (2023 vs 2024)</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin:0; padding:0; font-family: Arial, sans-serif; }
    #map { height:100vh; }
    .info {
      padding: 8px 12px;
      background: white;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      line-height: 1.5;
    }
    button {
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .legend i {
      display:inline-block;
      width:12px;
      height:12px;
      margin-right:4px;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
// =======================
// MAP SETUP
// =======================
const map = L.map('map').setView([-10.5, -62.5], 8);

// Base OSM tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors',
  maxZoom: 18
}).addTo(map);

// =======================
// IMAGE BOUNDS
// =======================
const imageBounds = [[-13, -65], [-8, -60]];

// =======================
// FALSE COLOR IMAGES (BASE LAYERS)
// =======================
const overlay2023 = L.imageOverlay('2023_falsecolor.png', imageBounds, {opacity: 0.85});
const overlay2024 = L.imageOverlay('2024_falsecolor.png', imageBounds, {opacity: 0.0});
overlay2023.addTo(map); // start with 2023

let currentYear = '2023';

// =======================
// HOTSPOTS GEOJSON (OVERLAY)
// =======================
let hotspots;

fetch('./Loss_Hotspots_Leaflet.geojson')
  .then(res => {
    if (!res.ok) throw new Error('Failed to load GeoJSON');
    return res.json();
  })
  .then(data => {
    console.log('GeoJSON loaded:', data.features.length, 'features');

    hotspots = L.geoJSON(data, {
      style: {
        color: '#ffff00',
        weight: 1.2,
        fillColor: '#ffff00',
        fillOpacity: 0.45
      },
      onEachFeature: function(feature, layer) {
        const areaRaw = feature.properties.area_ha;
        const areaHa = (!isNaN(areaRaw)) ? Number(areaRaw) : null;
        layer.bindPopup(
          `<b>Deforestation Hotspot</b><br>
           Area: ${areaHa ? areaHa.toFixed(2) + ' ha' : 'N/A'}<br>
           Detected 2023–2024`
        );
      }
    });

    // =======================
    // LAZY-LOAD HOTSPOTS (only when checkbox is ticked)
    // =======================
    const overlays = {
      "Deforestation Hotspots": hotspots
    };

    overlays["Deforestation Hotspots"].onAdd = function() {
      hotspots.addTo(map);
      console.log('Hotspots layer added to map');
    };

    overlays["Deforestation Hotspots"].onRemove = function() {
      map.removeLayer(hotspots);
      console.log('Hotspots layer removed from map');
    };

    // =======================
    // LAYER CONTROL
    // =======================
    const baseLayers = {
      "2023 False Color": overlay2023,
      "2024 False Color": overlay2024
    };

    L.control.layers(baseLayers, overlays, {
      position: 'topright',
      collapsed: false
    }).addTo(map);
  })
  .catch(err => console.error('GeoJSON load failed:', err));

// =======================
// SYNC YEAR WHEN RADIO BUTTON CLICKED
// =======================
map.on('baselayerchange', function(e) {
  if (e.name === '2023 False Color') currentYear = '2023';
  if (e.name === '2024 False Color') currentYear = '2024';
  console.log('Year changed via control:', currentYear);
});

// =======================
// SWITCH YEAR BUTTON
// =======================
const toggleControl = L.control({ position: 'topleft' });
toggleControl.onAdd = function () {
  const div = L.DomUtil.create('div', 'info');
  div.innerHTML = '<button onclick="toggleYear()">Switch Year</button>';
  return div;
};
toggleControl.addTo(map);

window.toggleYear = function () {
  if (currentYear === '2023') {
    map.removeLayer(overlay2023);
    map.addLayer(overlay2024);
    currentYear = '2024';
  } else {
    map.removeLayer(overlay2024);
    map.addLayer(overlay2023);
    currentYear = '2023';
  }
  console.log('Year toggled:', currentYear);
};

// =======================
// INFO PANEL
// =======================
const infoPanel = L.control({ position: 'bottomleft' });
infoPanel.onAdd = function () {
  const div = L.DomUtil.create('div', 'info');
  div.innerHTML = `
    <h4>Amazon Deforestation Monitoring</h4>
    <p>
      Rondônia sub-region<br>
      Sentinel-2 false color (2023 vs 2024)<br>
      Hotspots: NDVI drop ≥ 0.20<br>
      Estimated loss: ~579 km²
    </p>
  `;
  return div;
};
infoPanel.addTo(map);

// =======================
// LEGEND
// =======================
const legend = L.control({position: 'bottomright'});
legend.onAdd = function () {
  const div = L.DomUtil.create('div', 'info legend');
  div.innerHTML = `
    <h4>Legend</h4>
    <div>
      <i style="background:#ffff00"></i> Potential Deforestation Hotspots (2023–2024)<br>
    </div>
    <div style="margin-top:8px;">
      <strong>Base Layers:</strong><br>
      2023 / 2024 False Color (NIR-Red-Green)
    </div>
  `;
  return div;
};
legend.addTo(map);
</script>
</body>
</html>
